{% extends "base.html" %}

{% block title %}Órdenes de Compra{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <h2 class="mb-4 text-center">Órdenes de Compra Recibidas</h2>
            
            <div class="mb-3">
                <a href="{{ url_for('home') }}" class="btn btn-secondary">← Volver al Inicio</a>
                <span class="float-end"><strong>Total de órdenes: {{ orders|length }}</strong></span>
            </div>

            {% if orders %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID Orden</th>
                                <th>Cliente</th>
                                <th>Teléfono</th>
                                <th>Total</th>
                                <th>Productos</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td><strong>#{{ order.id }}</strong></td>
                                <td>{{ order.customer_name }}</td>
                                <td>
                                    {% if order.customer_phone != 'Vía WhatsApp' %}
                                        <a href="tel:{{ order.customer_phone }}">{{ order.customer_phone }}</a>
                                    {% else %}
                                        {{ order.customer_phone }}
                                    {% endif %}
                                </td>
                                <td><strong>${{ "%.2f"|format(order.total_amount) }}</strong></td>
                                <td>
                                    <span class="badge bg-info">{{ order.total_items }} productos</span>
                                </td>
                                <td>
                                    {% if order.status == 'pending' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% elif order.status == 'completed' %}
                                        <span class="badge bg-success">Completada</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ order.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.fecha_orden.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails({{ order.id }})">
                                        Ver Detalles
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info text-center">
                    <h4>No hay órdenes de compra</h4>
                    <p>Aún no se han recibido órdenes a través del carrito de compras.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para detalles de orden -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles de la Orden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent">
                    Cargando detalles...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
async function viewOrderDetails(orderId) {
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    const content = document.getElementById('orderDetailsContent');
    
    content.innerHTML = 'Cargando detalles...';
    modal.show();
    
    try {
        const response = await fetch(`/order_details/${orderId}`);
        const details = await response.json();
        
        if (details.success) {
            let html = '<div class="list-group">';
            details.items.forEach(item => {
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item.product_name}</strong>
                            <br><small>Cantidad: ${item.quantity}</small>
                        </div>
                        <span class="badge bg-primary">$${item.product_price}</span>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        } else {
            content.innerHTML = '<div class="alert alert-danger">Error al cargar detalles</div>';
        }
    } catch (error) {
        content.innerHTML = '<div class="alert alert-danger">Error de conexión</div>';
    }
}
</script>

<style>
.table th {
    vertical-align: middle;
    text-align: center;
}
.table td {
    vertical-align: middle;
}
.container {
    max-width: 1400px;
}
</style>
{% endblock %}